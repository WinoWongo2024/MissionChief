<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DispÃ  UK Local Operations Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- MODERN DARK THEME OVERHAUL (Unchanged) --- */
        
        /* Typography and Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0f1b; /* Ultra-Dark Blue Background */
            color: #e2e8f0; /* Soft White Text */
            min-height: 100vh;
        }
        
        /* Card Styling - More defined and lifted look */
        .card {
            background-color: #161c2e; /* Darker Card Background */
            border: 1px solid #2d3748; /* Subtle Blue-Gray Border */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5); /* Stronger Shadow */
            border-radius: 1.25rem; /* Slightly rounder corners */
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 6px 20px rgba(0, 163, 255, 0.15); /* Subtle blue hover glow */
        }

        /* KPI Card Styling - Highlighting primary data */
        .kpi-card {
            background-color: #1c233a; /* Slightly lighter for contrast against main card */
            border-left: 4px solid #00a3ff; /* Primary Blue Accent */
            border-radius: 0.75rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 163, 255, 0.2); 
        }
        .kpi-value {
            color: #00a3ff; /* Primary Blue for main values */
        }

        /* Call Status Colors - High-contrast for alerts */
        .call-low { color: #10b981; } /* Green */
        .call-medium { color: #f59e0b; } /* Amber */
        .call-high { color: #ef4444; } /* Red */
        
        /* Status Text Colors */
        .status-operational { color: #10b981; } /* Green */
        .status-planned { color: #f59e0b; } /* Amber */
        .status-offline { color: #ef4444; } /* Red */


        /* News Feed Category Tags - Bolder Colors */
        .category-tag {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .category-tag.Corporate { background-color: rgba(100, 100, 255, 0.2); color: #8090ff; } 
        .category-tag.Expansion { background-color: rgba(0, 163, 255, 0.2); color: #00a3ff; } 
        .category-tag.Police { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .category-tag.Fire { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .category-tag.Medical { background-color: rgba(16, 185, 129, 0.2); color: #34d399; }
        .category-tag.SAR { background-color: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .category-tag.Logistics { background-color: rgba(148, 163, 184, 0.2); color: #94a3b8; }
        
        /* Scrollbar Styling for News Feed and Tables */
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #161c2e; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Table Styling */
        .data-table th, .data-table td {
            white-space: nowrap; 
            border-color: #2d3748 !important; /* Ensure separation */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 md:mb-10">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white leading-tight">
                <span class="text-blue-400">DispÃ  UK</span> Operations Dashboard
            </h1>
            <p id="update-time" class="text-sm text-gray-400 mt-1">
                Last Data Refresh: Loading...
            </p>
        </header>

        <div class="card p-4 md:p-6 mb-8 flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
            <label for="region-selector" class="text-base sm:text-lg font-semibold text-white">View Local Operations For:</label>
            <select id="region-selector" class="bg-[#0c0f1b] border border-gray-600 rounded-lg p-2 text-white text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500 w-full sm:w-2/5 md:w-1/3" onchange="handleRegionChange(this.value)">
                <option value="default" disabled selected>Select Your Region</option>
                <option value="Basingstoke_Alton_Oakley">Basingstoke, Alton, Oakley Dispatch</option>
                <option value="London_Central">Central, South/North East London Dispatch</option>
                <option value="Harrogate">Harrogate District Dispatch Centre (Ã–estVÃ¨l CentrÃ¨)</option>
                <option value="National_Highways_South">National Highways (South England)</option>
                <option value="Southampton_Planned">Pâ€™mouth, Sâ€™ampton, Eâ€™leigh Dispatch</option>
                <option value="Scarborough_Whitby_Bridlington">Scâ€™boro, Whitby, Bridlington Dispatch</option>
                <option value="London_West">West, South, SW, NW North London Dispatch</option>
            </select>
        </div>

        <div id="kpi-summary" class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6 mb-8">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div id="call-stats-container" class="card p-4 md:p-6 lg:col-span-2 flex flex-col space-y-4">
                <h2 class="text-lg md:text-xl font-bold text-white border-b border-gray-700/50 pb-2">Real-time Call Statistics & System Load</h2>
                </div>
            
            <div class="card p-4 lg:col-span-1 flex flex-col">
                <h2 class="text-lg md:text-xl font-bold mb-3 text-white flex items-center border-b border-gray-700/50 pb-2">
                    <span class="mr-2 text-red-500">ðŸ“¢</span> DispÃ  UK News Feed
                </h2>
                <div id="news-feed-container" class="space-y-3 h-full max-h-[500px] overflow-y-auto pr-2 scrollable-content">
                </div>
            </div>

            <div class="card p-4 md:p-6 lg:col-span-3 flex flex-col space-y-4">
                <h2 class="text-lg md:text-xl font-bold text-white border-b border-gray-700/50 pb-2">Regional Capacity & Service Mix (Global View)</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 h-auto min-h-[300px]">
                    <div class="h-64 sm:h-auto"><canvas id="assetMixChart"></canvas></div>
                    <div class="h-64 sm:h-auto"><canvas id="regionalDistributionChart"></canvas></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="p-4 md:p-6">
                <h2 id="local-viewer-title" class="text-lg sm:text-xl font-bold text-blue-400 mb-4">Local Operations: Select a Region Above</h2>
                <div id="content-container" class="min-h-[25vh]">
                    <p class="text-center text-gray-500 py-10">Use the selector above to filter local assets.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL VARIABLES AND CONFIGURATION ---

        // (Unchanged)
        const regionMap = {
            'Basingstoke_Alton_Oakley': 'Basingstoke,Alton,Oakley Dispatch',
            'London_Central': 'Central,South/North East London Dispatch',
            'Harrogate': 'Harrogate District Dispatch Centre',
            'National_Highways_South': 'National Highways (South England)',
            'Southampton_Planned': 'Pâ€™mouth,Sâ€™ampton,Eâ€™leigh Dispatch',
            'Scarborough_Whitby_Bridlington': 'Scâ€™boro,Whitby,Bridlington Dispatch',
            'London_West': 'West, South, SW,NW North London Dispatch'
        };

        // (Unchanged)
        const areaStatus = {
            'London_Central': { name: 'Central London / NE', status: 'Operational', color: 'status-operational' },
            'London_West': { name: 'West London / SW / NW', status: 'Operational', color: 'status-operational' },
            'Harrogate': { name: 'Harrogate (Ã–estVÃ¨l CentrÃ¨)', status: 'Operational', color: 'status-operational' },
            'Southampton_Planned': { name: 'South Coast (Active)', status: 'Operational', color: 'status-operational' }, 
            'Basingstoke_Alton_Oakley': { name: 'Basingstoke, Alton & Oakley', status: 'Operational', color: 'status-operational' },
            'National_Highways_South': { name: 'National Highways (South)', status: 'Operational', color: 'status-operational' },
            'Scarborough_Whitby_Bridlington': { name: 'Scâ€™boro, Whitby, Bridlington', status: 'Operational', color: 'status-operational' },
            'default': { name: 'Select Region', status: 'Unknown', color: 'text-gray-400' }
        };
        
        let activeRegionKey = 'default';
        let assetMixChart = null;
        let regionalChart = null;
        let stats = {};

        // *** UPDATED *** Call and Capacity Constants
        const MAX_SIMULTANEOUS_CALLS = 24; // Updated from 17
        const AVG_CALL_DURATION_MINS = 15; // Unchanged
        const AVG_CALLS_PER_MINUTE = 3; // Updated (1 call every 20 seconds)
        
        // Daily Call Counter State
        let callsToday = 0;
        let lastDayUpdate = new Date().getDate(); 

        // Simulated/Real-Time Call Data (Initial State)
        let callStats = {
            currentCalls: 0,
            callLoadPercentage: 0
        };

        // *** UPDATED ***
        // --- NEW DETAILED DATA DEFINITION (Re-Parsed based on your feedback) ---
        const dispatchData = {
            'Basingstoke,Alton,Oakley Dispatch': [
                { station: "Basingstoke Fire Station", code: "HFS-005", location: "BSKS", assets: "2 x BSKS | HFS-005/BASU-001, 2 x BSKS | HFS-005/CARP-001", type: "Fire", count: 4 },
                { station: "Basingstoke Station", code: "HPS-008", location: "BSKS", assets: "4 x BSKS | HPS-008/IRV-001", type: "Police", count: 4 },
                { station: "Basingstoke South", code: "HSF-006", location: "BSKS", assets: "2 x BSKS | HSF-006/CARP-001, 2 x BSKS | HSF-006/WC-001", type: "Fire", count: 4 },
                { station: "Old Basing Police", code: "N/A", location: "N/A", assets: "4 x IRV, 6 x IRV, 6 x IRV", type: "Police", count: 16 },
                { station: "Basingstoke Hospital", code: "SCAS-003", location: "BSKS", assets: "2 x BSKS | SCAS-003/AMB-001", type: "Medical", count: 2 }
            ],
            'Central,South/North East London Dispatch': [
                { station: "Victoria & Pimlico", code: "BTP-001", location: "BTPV&P", assets: "2 x BTPV&P | BTP-001/IRV-002, 2 x BTPV&P | BTP-001/IRV-001", type: "Police", count: 4 },
                { station: "Kingâ€™s Cross & St Pancras", code: "BTP-002", location: "KGXSP", assets: "2 x KGXSP | BTP-002/IRV-001, 2 x KGXSP | BTP-002/IRV-002", type: "Police", count: 4 },
                { station: "Greenwich (Millwall)", code: "CRS-001", location: "GWCH", assets: "2 x GWCH | CRS-001/CRV-001, 2 x GWCH | CRS-001/CRV-002", type: "SAR", count: 4 },
                { station: "Chelsea HART BASE (S/B)", code: "HART-001", location: "CB", assets: "2 x CB | HART-001/AMB-001, 2 x CB | HART-001/OTL-001, 2 x CB | HART-001/PRV-001, 2 x CB | HART-001/PRV-002, 2 x CB | HART-001/SRV-001", type: "Medical", count: 10 },
                { station: "Heathrow Airport", code: "HEMS-001", location: "HTR", assets: "2 x HTR | HEMS-001/HELI-001, 2 x HTR | HEMS-001/RRV-001, 2 x HTR | HEMS-001/RRV-002, 2 x HTR | HEMS-001/RRV-003", type: "Medical", count: 8 },
                { station: "City of London Fire officer", code: "HRL-001", location: "CoL", assets: "2 x CoL | HRL-001/FO-001", type: "Fire", count: 2 },
                { station: "Elephant and Castle", code: "HRL-002", location: "EaC", assets: "2 x EaC | HRL-002/GNRL-PRAC-001", type: "Medical", count: 2 },
                { station: "Lambeth HRL/SB", code: "HRL-003", location: "LMBTH", assets: "2 x LMBTH | HRL-003/FO-001", type: "Fire", count: 2 },
                { station: "Holborn HRL Station", code: "HRL-004", location: "HLBRN", assets: "2 x HLBRN | HRL-004/FO-001", type: "Fire", count: 2 },
                { station: "Vauxhall LAS HRL", code: "HRL-006", location: "VXHL", assets: "2 x VXHL | HRL-006/RRV-001", type: "Medical", count: 2 },
                { station: "Rotherhithe SAR HRL", code: "HRL-008", location: "RHTHT", assets: "2 x RHTHT | HRL-008/SAR4x4-001", type: "SAR", count: 2 },
                { station: "Traffalgar SQR HRL", code: "HRL-009", location: "TRFSQR", assets: "2 x TRFSQR | HRL-009/CFR", type: "Medical", count: 2 },
                { station: "City of Westminster", code: "LAS-001/CC", location: "CoW", assets: "2 x CoW | LAS-001/AMB-001, 2 x CoW | LAS-001/AMB-002, 2 x CoW | LAS-001/RRV-001", type: "Medical", count: 6 },
                { station: "Euston Ambulance Station", code: "LAS-002", location: "EUS", assets: "2 x EUS | LAS-002/AMB-001, 2 x EUS | LAS-002/CBRN-001, 2 x EUS | LAS-002/OTL-001", type: "Medical", count: 6 },
                { station: "Knightsbridge Station", code: "LAS-003", location: "KBR", assets: "2 x CBRN Vehicle, 2 x KBR | LAS-003/AMB-001, 2 x KBR | LAS-003/RRV-001", type: "Medical", count: 6 },
                { station: "Westminster Bridge station", code: "LAS-005", location: "WBR", assets: "2 x WBR | LAS-005/AMB-001, 2 x WBR | LAS-005/AMB-002", type: "Medical", count: 4 },
                { station: "Guys Hospital AMB-DEP", code: "LAS-006", location: "GH", assets: "2 x GH | LAS-006/AMB-001, 2 x GH | LAS-006/RRV-001, 2 x Mass Casualty Equipment", type: "Medical", count: 6 },
                { station: "Bethnal Green", code: "LFB-001", location: "BTGN", assets: "2 x BTGN | LFB-001/WC-001, 2 x BTGN | LFB-001/WL-001, 2 x RP CAFS, 2 x WrL CAFS", type: "Fire", count: 8 },
                { station: "City of London", code: "LFB-002", location: "CoL", assets: "2 x CoL | LFB-002/RSU-001, 2 x CoL | LFB-002/WL-001, 2 x HazMat Unit", type: "Fire", count: 6 },
                { station: "Deptford LFB Station", code: "LFB-003", location: "DEPT", assets: "2 x DEPT | LFB-003/RP-001, 2 x DEPT| LFB-003/CARP-001, 2 x Welfare Vehicle", type: "Fire", count: 6 },
                { station: "Euston LFB Station", code: "LFB-004", location: "EUS", assets: "2 x EUS | LFB-004/ARAP-001, 2 x EUS | LFB-004/BASU-001, 2 x EUS | LFB-004/WL-001", type: "Fire", count: 6 },
                { station: "North Whitechapel Station", code: "LFB-006", location: "NWCP", assets: "2 x NWCP | LFB-006/WL-001, 2 x NWCP | LFB-006/WL-002", type: "Fire", count: 4 },
                { station: "Queensway Station", code: "LFB-007", location: "QW", assets: "2 x QW | LFB-007/WL-001, 2 x QW | LFB-007/WL-002", type: "Fire", count: 4 },
                { station: "Whitechapel station", code: "LFB-008", location: "WCP", assets: "2 x WCP | LFB-008/L4x4-001, 2 x WCP | LFB-008/WL-001, 2 x Boat Trailer, 2 x Light 4x4, 2 x PM, 2 x Rescue Pod", type: "Fire", count: 12 },
                { station: "Shoreditch (N)", code: "LFB-010", location: "SHRD (N)", assets: "2 x SHRD (N) | LFB-010/CARP-001, 2 x SHRD (N) | LFB-010/WFV-001", type: "Fire", count: 4 },
                { station: "City of London Police", code: "MET-001", location: "CoLP", assets: "2 x CoLP | MET-001/IRV-001, 2 x CoLP | MET-001/IRV-002", type: "Police", count: 4 },
                { station: "Ingleton MET station", code: "MET-002", location: "ING", assets: "2 x ING | MET-002/IRV-001, 2 x ING | MET-002/IRV-002", type: "Police", count: 4 },
                { station: "Westminster/No 10", code: "MET-004", location: "WM10", assets: "2 x WM10 | MET-004/DSU-001, 2 x WM10 | MET-004/IRV-001", type: "Police", count: 4 },
                { station: "Queensway Station", code: "MET-005", location: "QW", assets: "2 x QW | MET-005/ARV-001, 2 x QW | MET-005/IRV-001, 2 x QW | MET-005/IRV-002", type: "Police", count: 6 },
                { station: "Strand Station", code: "MET-006", location: "STR", assets: "2 x STR | MET-006/IRV-001, 2 x STR | MET-006/MRAV-001", type: "Police", count: 4 },
                { station: "Tower Hamlets Station", code: "MET-007", location: "THML", assets: "2 x THML | MET-007/IRV-001, 2 x THML | MET-007/IRV-002", type: "Police", count: 4 },
                { station: "Monument HRL", code: "N/A", location: "N/A", assets: "2 x Fire Officer", type: "Fire", count: 2 },
                { station: "ORM-B-T-01 NR30", code: "N/A", location: "N/A", assets: "2 x RRV", type: "Logistics", count: 2 },
                { station: "Chelsea RCC", code: "RCC-001", location: "CHLSE", assets: "2 x CHLSE | RCC-001/FBRC-001, 2 x CHLSE | RCC-001/FBRC-002", type: "Logistics", count: 4 },
                { station: "Westminster LFBS N/E L/S", code: "RNLI-001", location: "WSTMâ€™R", assets: "2 x WSTMâ€™R | RNLI-001/4X4-001, 2 x WSTMâ€™R | RNLI-001/ILB-001", type: "SAR", count: 4 },
                { station: "HQ Westminster", code: "SAR-001", location: "WSTMâ€™R", assets: "2 x WSTMâ€™R | SAR-001/OST-001, 2 x WSTMâ€™R | SAR-001/OSV-001, 2 x WSTMâ€™R | SAR-001/SAR4X4-001", type: "SAR", count: 6 }
            ],
            'Harrogate District Dispatch Centre': [
                { station: "Harrogate Fire station", code: "HRLNY-001", location: "HGFS", assets: "2 x HGFS | HRLNY-001/FO-001", type: "Fire", count: 2 },
                { station: "HDH OTL", code: "HRLNY-002", location: "HDH", assets: "2 x HDH | HRLNY-OTL-001", type: "Medical", count: 2 },
                { station: "Harrogate Fire Station", code: "NYF-001", location: "HFS", assets: "2 x HFS | NYF-001/WL-001, 2 x HFS | NYF-001/WL-002", type: "Fire", count: 4 },
                { station: "Knaresborough Fire Station", code: "NYF-002", location: "KBR", assets: "2 x KBR | NYF-002/FO-001, 2 x KBR | NYF-002/WL-001", type: "Fire", count: 4 },
                { station: "Ripon Fire Station", code: "NYF-003", location: "RPN", assets: "2 x RPN | NYF-003/RP-001, 2 x RPN | NYF-003/WL-001", type: "Fire", count: 4 },
                { station: "Summerbridge Fire station", code: "NYF-004", location: "SMBR", assets: "2 x SMBR | NYF-004/WL-001, 2 x SMBR | NYF-004/WL-002", type: "Fire", count: 4 },
                { station: "Harrogate Magistrate court", code: "NYP-001", location: "HMC", assets: "2 x HMC | NYP-001/IRV-001, 2 x HMC | NYP-001/IRV-001", type: "Police", count: 4 },
                { station: "Harrogate Police Station", code: "NYP-002", location: "HPS", assets: "2 x HPS | NYP-002/DSU-001, 2 x HPS | NYP-002/IRV-001", type: "Police", count: 4 },
                { station: "Pateley Bridge", code: "NYP-003", location: "PBR", assets: "2 x PBR | NYP-003/IRV-001, 2 x PBR | NYP-003/IRV-002", type: "Police", count: 4 },
                { station: "Harrogate Hospital Station", code: "YAS-001", location: "Hâ€™GTE", assets: "5 x Hâ€™GTE | YAS-001/AMB-001, 2 x Hâ€™GTE | YAS-001/RRV-001", type: "Medical", count: 7 },
                { station: "Harrogate Ambulance station", code: "YAS-002", location: "HGTAS", assets: "2 x HGTAS | YAS-002/AMB-001, 2 x HGTAS | YAS-002/AMB-002", type: "Medical", count: 4 }
            ],
            'National Highways (South England)': [
                { station: "Camberley NH", code: "NHE-001", location: "CMBRLY", assets: "4 x NHE-001 | CMBRLY/NH-001", type: "Police", count: 4 },
                { station: "Camberley SFS", code: "NHE-001", location: "N/A", assets: "2 x CARP", type: "Fire", count: 2 },
                { station: "Ashford Common", code: "NHE-002", location: "ACM", assets: "2 x NH-002 | ACM/NH-001", type: "Police", count: 2 }
            ],
            'Pâ€™mouth,Sâ€™ampton,Eâ€™leigh Dispatch': [
                { station: "Chilworth OLD HPS", code: "N/A", location: "N/A", assets: "2 x Aerial Appliance, 2 x CARP, 2 x Rescue Support Unit (RSU)", type: "Fire", count: 6 },
                { station: "Southampton Central FS", code: "HFS-001", location: "SHPTCFS", assets: "2 x SHPTCFS | HFS-001/WL-001, 2 x SHPTCFS | HFS-001/WL-002, 2 x HazMat Unit", type: "Fire", count: 6 },
                { station: "Redbridge Fire Station", code: "HFS-002", location: "RBR", assets: "2 x RBR | HFS-002/BASU-001, 2 x RBR | HFS-002/CARP-001, 2 x ICCU", type: "Fire", count: 6 },
                { station: "St Maryâ€™s Fire station", code: "HFS-003", location: "STMRYFS", assets: "2 x STMRYFS | HFS-003/RSU-001, 6 x STMRYFS | HFS-003/WL-001, 6 x CARP, 2 x Welfare Vehicle", type: "Fire", count: 16 },
                { station: "HPFS,IoW Eastleigh HQ", code: "HFS-004", location: "ELGH", assets: "2 x ELGH | HFS-004/CARP-001, 2 x ELGH | HFS-004/FO-001, 2 x CARP, 2 x Drone Vehicle (Fire Station), 2 x Drone Vehicle (Fire Station)", type: "Fire", count: 10 },
                { station: "Southampton Central Station", code: "HPS-001", location: "SMPC", assets: "2 x SMPC | HPS-001/IRV-001, 2 x SMPC | HPS-001/IRV-002, 2 x ARV", type: "Police", count: 6 },
                { station: "Portswood Station", code: "HPS-002", location: "PW", assets: "2 x PW | HPS-002/IRV-001, 2 x PW | HPS-002/IRV-002, 2 x DSU", type: "Police", count: 6 },
                { station: "Hythe Police Station", code: "HPS-003", location: "HYPS", assets: "2 x HYPS | HPS-003/IRV-001, 2 x Detention Van, 2 x Firearms Personnel Carrier, 2 x Mounted Unit, 2 x Multiple Dog Carrier", type: "Police", count: 10 },
                { station: "Totton Police Station", code: "HPS-004", location: "TTNPS", assets: "2 x TTNPS | HPS-004/IRV-001, 2 x ARV, 2 x Mounted Unit", type: "Police", count: 6 },
                { station: "Shirley Police station", code: "HPS-005", location: "SHLYPS", assets: "2 x SHLYPS | HPS-005/IRV-001", type: "Police", count: 2 },
                { station: "Swaythling Police station", code: "HPS-006", location: "SWYG", assets: "2 x SWYG | HPS-006/IRV-001", type: "Police", count: 2 },
                { station: "Eastleigh Airport", code: "HPS-007", location: "EGLHAP", assets: "2 x EGLHAP | HPS-007/IRV-001, 2 x Traffic Car", type: "Police", count: 4 },
                { station: "Marsh Lane HRL", code: "N/A", location: "N/A", assets: "2 x RRV", type: "Logistics", count: 2 },
                { station: "Redbridge HRL/FO", code: "N/A", location: "N/A", assets: "2 x Fire Officer", type: "Fire", count: 2 },
                { station: "Regentâ€™s Park Southampton RCC", code: "N/A", location: "N/A", assets: "2 x Flatbed Recovery Vehicle, 2 x Flatbed Recovery Vehicle, 2 x HGV Recovery Vehicle", type: "Logistics", count: 6 },
                { station: "Southampton General station", code: "SCAS-001", location: "STHPGS", assets: "2 x STHPGS | SCAS-001/AMB-001, 2 x STHPGS | SCAS-001/AMB-002, 2 x Mass Casualty Equipment", type: "Medical", count: 6 },
                { station: "Chandlers ford Station", code: "SCAS-002", location: "CFS", assets: "2 x CFS | SCAS-002/AMB-001, 2 x CFS | SCAS-002/OTL-001", type: "Medical", count: 4 },
                { station: "SGH/HRL", code: "N/A", location: "N/A", assets: "2 x Coastguard Commander", type: "SAR", count: 2 },
                { station: "Southampton CGS", code: "N/A", location: "N/A", assets: "2 x CRV, 2 x Coastguard Rope Rescue Unit, 2 x Flood Rescue Unit (Trailer), 2 x Search Dog Unit", type: "SAR", count: 8 },
                { station: "Southampton Common HRL (S)", code: "N/A", location: "N/A", assets: "2 x Fire Officer", type: "Fire", count: 2 },
                { station: "Southampton Port SRHQ", code: "SARHQ-001", location: "STHP", assets: "2 x STHP | SARHQ-001/4x4-001, 2 x STHP | SARHQ-001/CC-001, 2 x STHP | SARHQ-001/OST-001, 2 x Crew Carrier (SAR), 2 x SAR Flood Rescue (Trailer), 2 x SAR Flood Rescue (Trailer)", type: "SAR", count: 12 }
            ],
            'Scâ€™boro,Whitby,Bridlington Dispatch': [
                { station: "North Bay CRS", code: "N/A", location: "N/A", assets: "2 x CRV", type: "SAR", count: 2 },
                { station: "Scarborough ambulance station", code: "N/A", location: "N/A", assets: "2 x Ambulance, 2 x Ambulance", type: "Medical", count: 4 },
                { station: "Scarborough fire station", code: "N/A", location: "N/A", assets: "2 x CARP, 2 x CARP", type: "Fire", count: 4 },
                { station: "Scarborough lifeboat station", code: "N/A", location: "N/A", assets: "2 x 4x4 Vehicle, 2 x ALB", type: "SAR", count: 4 },
                { station: "Scarborough Police Station", code: "N/A", location: "N/A", assets: "2 x IRV, 2 x IRV", type: "Police", count: 4 },
                { station: "Scarborough RCC", code: "N/A", location: "N/A", assets: "2 x Flatbed Recovery Vehicle", type: "Logistics", count: 2 },
                { station: "Scarborough SARHQ", code: "N/A", location: "N/A", assets: "2 x SAR 4x4", type: "SAR", count: 2 }
            ],
            'West, South, SW,NW North London Dispatch': [
                { station: "St James park", code: "BTP-003", location: "SJP", assets: "2 x SJP | BTP-003/IRV-001, 2 x SJP | BTP-003/RTPC-001", type: "Police", count: 4 },
                { station: "MarbleArch LAS HRL", code: "HRL-005", location: "MA", assets: "2 x MA | HRL-005/RRV-001", type: "Medical", count: 2 },
                { station: "Piccadilly CFR HRL", code: "HRL-007", location: "PCDLY", assets: "2 x PCDLY | HRL-007/CFR-001", type: "Medical", count: 2 },
                { station: "Knightsbridge HRL (FO)", code: "N/A", location: "N/A", assets: "2 x Fire Officer", type: "Fire", count: 2 },
                { station: "MarbleArch Station", code: "LAS-004", location: "MA", assets: "5 x MA | LAS-004/AMB-001, 5 x MA | LAS-004/AMB-002, 2 x Specialist Paramedic RRV", type: "Medical", count: 12 },
                { station: "MarbleArch", code: "LFB-005", location: "MA", assets: "2 x MA | LFB-005/RSU-001, 2 x MA | LFB-005/WL-001", type: "Fire", count: 4 },
                { station: "Willesden Fire Station", code: "LFB-009", location: "WFS", assets: "2 x WFS | LFB-009/BASU-001, 2 x WFS | LFB-009/CARP-001", type: "Fire", count: 4 },
                { station: "MarbleArch", code: "MET-003", location: "MBA", assets: "2 x MBA | MET-003/IRV-001, 2 x MBA | MET-003/IRV-002", type: "Police", count: 4 },
                { station: "Heathrow Airport", code: "NPAS-001", location: "N/A", assets: "2 x Police helicopter", type: "Police", count: 2 },
                { station: "West Hampstead LAS", code: "N/A", location: "N/A", assets: "2 x Ambulance, 2 x Patient Transport Service Ambulance", type: "Medical", count: 4 }
            ]
        };


                // Static or user-provided news updates (UPDATED by user request - 20:17 OVST)
        let newsUpdates = [
            // Ã–estVÃ¨l (Harrogate) / North Yorkshire Focus
            { timestamp: '20:15 OVST', headline: 'Ã–estVÃ¨l Royal Decree: Annual TMC Brunch scheduled for Monday. All units to remain on high alert.', category: 'Ã–estVÃ¨l Event' },
            { timestamp: '19:30 OVST', headline: 'Ripon Station Update: Joint Police/Fire Station refurbishment complete. Â£926,000 VCâ‚¬ 1,814,960 investment confirmed.', category: 'Fire' },
            { timestamp: '18:50 OVST', headline: 'Scarborough Lights Event: High resource planning initiated for illuminated light festival starting November 14th.', category: 'Scarborough Event' },
            { timestamp: '17:00 OVST', headline: 'Operation Trailblaze: Rural Police patrols continue across North Yorkshire to tackle anti-social driving.', category: 'Police' },
            
            // Major National Infrastructure & Health Updates
            { timestamp: '15:45 OVST', headline: 'National Health: New resource toolkit launched to support ambulance staff after distressing incidents.', category: 'Medical' },
            { timestamp: '14:20 OVST', headline: 'UKHSA: Flu Vaccine Campaign underway. Over 5 million under-65s urged to vaccinate.', category: 'Medical' },

            // Retained Key Historical/Corporate Updates (With Adjusted Timestamps)
            { timestamp: '12:00 OVST', headline: 'End of October Financial Report (EoOFR) Scheduled for **23:59 Release** Today.', category: 'Corporate' },
            { timestamp: '11:30 OVST', headline: 'Isle of Wight Major Development Plan Approved: New Hospitals & Operational Centers.', category: 'Expansion' },
            { timestamp: '10:00 OVST', headline: 'DispÃ  UK Confirms **Southampton** as Next Primary Infrastructure Target (Original Announcement).', category: 'Expansion' },
            { timestamp: '08:00 OVST', headline: 'London Central RCC Flatbed Recovery Units Deployed to M4 Emergency.', category: 'Logistics' },
            { timestamp: '06:00 OVST', headline: 'SAR HQ Westminster reports high readiness state for marine operations.', category: 'SAR' },
        ];



        // --- UTILITY FUNCTIONS ---

        // (Unchanged)
        function getUKTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const ukDate = new Date(utc); 
            const hours = String(ukDate.getHours()).padStart(2, '0');
            const minutes = String(ukDate.getMinutes()).padStart(2, '0');
            const seconds = String(ukDate.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds} GMT`;
        }
        
        // *** UPDATED *** Call Stats Simulation
        function simulateCallStats() {
            const now = new Date();
            const hour = now.getHours(); 
            const day = now.getDay();    
            const currentDay = now.getDate();
            const isWeekend = (day === 5 || day === 6); 

            // ** DAILY COUNTER RESET LOGIC **
            if (currentDay !== lastDayUpdate) {
                callsToday = 0; // Reset counter at midnight GMT
                lastDayUpdate = currentDay;
            }
            // ******************************

            let baseMultiplier = 0;
            const randomFluctuation = (Math.random() * 0.1) + 0.95; 

            // Time Period Multipliers
            if (hour >= 0 && hour < 8) { // Night (00:00 - 07:59)
                baseMultiplier = 0.33 + (Math.random() * 0.17); 
            } else if (hour >= 8 && hour < 12) { // Morning (08:00 - 11:59)
                baseMultiplier = 0.10 + (Math.random() * 0.23); 
            } else if (hour >= 12 && hour < 17) { // Afternoon (12:00 - 16:59)
                baseMultiplier = 0.5 + (Math.random() * 1.5); 
            } else if (hour >= 17 && hour < 24) { // Evening (17:00 - 23:59)
                baseMultiplier = 0.5 + (Math.random() * 0.5); 

                // Weekend/Friday Evening Boost
                if (isWeekend || (day === 5 && hour >= 17)) {
                    baseMultiplier *= 1.5; 
                }
            }

            // Current Concurrent Calls Logic
            const maxCallsBasedOnMultiplier = MAX_SIMULTANEOUS_CALLS * baseMultiplier * randomFluctuation;
            let simulatedCalls = Math.round(maxCallsBasedOnMultiplier);
            callStats.currentCalls = Math.min(simulatedCalls, MAX_SIMULTANEOUS_CALLS);
            
            // *** CORRECTED *** This line is fixed from the typo
            callStats.callLoadPercentage = ((callStats.currentCalls / MAX_SIMULTANEOUS_CALLS) * 100).toFixed(1);
            
            // ** DAILY CALL COUNTER INCREMENT LOGIC (Updated for 3x speed) **
            const refreshIntervalSeconds = 1; 
            // 1x load = AVG_CALLS_PER_MINUTE (3) calls per minute.
            const avgCallsPerSecond = (baseMultiplier * AVG_CALLS_PER_MINUTE) / 60; 
            
            if (Math.random() < avgCallsPerSecond * refreshIntervalSeconds) {
                 callsToday += 1;
            }
            
            // Corrects for counter starting at 0 if page loaded late in the day
            if (callsToday === 0 && hour > 0) {
                 // Estimate based on 0.2x load at 3 calls/min
                 const callsSinceMidnightEstimate = Math.round((hour * 60) * (AVG_CALLS_PER_MINUTE * 0.2)); 
                 callsToday = Math.max(0, callsSinceMidnightEstimate);
            }
        }

        // --- STATS CALCULATION (Unchanged, but now uses new data) ---

        function calculateStats() {
            let totalUnits = 0;
            const mix = { Police: 0, Fire: 0, Medical: 0, SAR: 0, Logistics: 0 };
            const regionalTotals = {};

            Object.keys(dispatchData).forEach(region => {
                let regionTotal = 0;
                dispatchData[region].forEach(unit => {
                    totalUnits += unit.count;
                    regionTotal += unit.count;
                    const type = mix.hasOwnProperty(unit.type) ? unit.type : 'Logistics';
                    mix[type] += unit.count;
                });
                
                let displayName;
                if (region.includes('Harrogate')) {
                    displayName = 'Ã–estVÃ¨l CentrÃ¨';
                } else if (region.includes('Sâ€™ampton')) {
                    displayName = 'South Coast Active';
                } else if (region.includes('West, South, SW')) {
                    displayName = 'West/NW London';
                } else if (region.includes('Basingstoke')) {
                    displayName = 'Basingstoke Area';
                } else if (region.includes('Scâ€™boro')) {
                    displayName = 'Scarborough Area';
                } else if (region.includes('National Highways')) {
                    displayName = 'Nat\'l Highways';
                } else {
                    displayName = region.split(',')[0].trim();
                }
                regionalTotals[displayName] = regionTotal; 
            });

            const policeFireRatio = mix.Police / mix.Fire;

            stats = {
                totalUnits: totalUnits,
                assetMix: mix,
                policeFireRatio: isFinite(policeFireRatio) ? policeFireRatio.toFixed(2) : 'N/A',
                regionalTotals: regionalTotals
            };
        }

        // --- UI RENDERING ---

        // (Unchanged)
        function renderKPIs() {
            const kpiContainer = document.getElementById('kpi-summary');
            const currentStatus = areaStatus[activeRegionKey] || areaStatus.default;
            
            simulateCallStats(); // Update call stats and daily counter

            let callColor = 'call-low'; 
            if (callStats.callLoadPercentage > 80) {
                 callColor = 'call-high'; 
            } else if (callStats.callLoadPercentage > 60) {
                 callColor = 'call-medium'; 
            }
            
            const now = new Date();
            const hours = now.getHours();
            let dayPeriod = 'Night';
            if (hours >= 8 && hours < 12) dayPeriod = 'Morning';
            else if (hours >= 12 && hours < 17) dayPeriod = 'Afternoon';
            else if (hours >= 17 && hours < 24) dayPeriod = 'Evening';


            kpiContainer.innerHTML = `
                <div class="kpi-card p-3 sm:p-4 rounded-xl">
                    <p class="text-xs sm:text-sm font-medium text-gray-400">Total Global Units</p>
                    <p class="text-xl sm:text-3xl font-extrabold kpi-value">${stats.totalUnits.toLocaleString()}</p>
                </div>
                <div class="kpi-card p-3 sm:p-4 rounded-xl">
                    <p class="text-xs sm:text-sm font-medium text-gray-400">Calls Today (GMT)</p>
                    <p class="text-xl sm:text-3xl font-extrabold text-white">${callsToday.toLocaleString()}</p>
                </div>
                <div class="kpi-card p-3 sm:p-4 rounded-xl">
                    <p class="text-xs sm:text-sm font-medium text-gray-400">Current Load (C/C)</p>
                    <p class="text-xl sm:text-3xl font-extrabold ${callColor}">${callStats.currentCalls} / ${MAX_SIMULTANEOUS_CALLS}</p>
                </div>
                <div class="kpi-card p-3 sm:p-4 rounded-xl">
                    <p class="text-xs sm:text-sm font-medium text-gray-400">Load Period Multiplier</p>
                    <p class="text-xl sm:text-3xl font-extrabold text-white">${dayPeriod} Load</p>
                </div>
                <div class="kpi-card p-3 sm:p-4 rounded-xl">
                    <p class="text-xs sm:text-sm font-medium text-gray-400">Regional Status: ${currentStatus.name.split('(')[0].trim()}</p>
                    <p class="text-xl sm:text-3xl font-extrabold ${currentStatus.color}">${currentStatus.status}</p>
                </div>
            `;
            document.getElementById('update-time').textContent = `Last Data Refresh: ${getUKTime()}`;
        }
        
        // (Unchanged)
        function renderNewsFeed() {
            const newsContainer = document.getElementById('news-feed-container');
            newsContainer.innerHTML = '';
            
            newsUpdates.forEach(item => {
                const tagClass = item.category || 'Logistics'; 
                newsContainer.innerHTML += `
                    <div class="bg-[#1c233a] p-3 rounded-lg border border-gray-700/50 hover:border-blue-500 transition duration-150">
                        <div class="flex justify-between items-center mb-1">
                            <span class="category-tag ${tagClass}">${item.category}</span>
                            <span class="text-xs text-gray-500">${item.timestamp}</span>
                        </div>
                        <p class="text-sm font-medium text-white">${item.headline}</p>
                    </div>
                `;
            });
        }

        // (Unchanged)
        function renderCharts() {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js not loaded. Cannot render charts.");
                return;
            }

            const ctxMix = document.getElementById('assetMixChart').getContext('2d');
            const ctxRegional = document.getElementById('regionalDistributionChart').getContext('2d');

            const mixLabels = Object.keys(stats.assetMix).filter(k => stats.assetMix[k] > 0);
            const mixData = mixLabels.map(k => stats.assetMix[k]);
            
            const regionalLabels = Object.keys(stats.regionalTotals);
            const regionalData = Object.values(stats.regionalTotals);

            if (assetMixChart) assetMixChart.destroy();
            if (regionalChart) regionalChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8', font: { size: 12 } } }, 
                    title: { display: true, color: '#e2e8f0', font: { size: 14, weight: '700' } } 
                },
                scales: {
                    x: { display: true, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(71, 85, 105, 0.2)' } },
                    y: { display: true, beginAtZero: true, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(71, 85, 105, 0.2)' } }
                }
            };

            assetMixChart = new Chart(ctxMix, {
                type: 'doughnut',
                data: {
                    labels: mixLabels,
                    datasets: [{
                        data: mixData,
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#a855f7'],
                        borderColor: '#161c2e', 
                        borderWidth: 4
                    }]
                },
                options: {
                    ...chartOptions, 
                    plugins: { 
                        ...chartOptions.plugins,
                        legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 10, font: { size: 11 } } },
                        title: { ...chartOptions.plugins.title, text: 'Asset Mix by Service Type' }
                    }
                }
            });

            regionalChart = new Chart(ctxRegional, {
                type: 'bar',
                data: {
                    labels: regionalLabels,
                    datasets: [{
                        label: 'Total Units',
                        data: regionalData,
                        backgroundColor: '#00a3ff', 
                        borderColor: '#008ae6',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions, 
                    plugins: {
                         ...chartOptions.plugins,
                         legend: { display: false },
                         title: { ...chartOptions.plugins.title, text: 'Units Deployed by Region' }
                    },
                }
            });
        }

        // *** UPDATED *** Call Stats Card
        function renderCallStatsCard() {
            const container = document.getElementById('call-stats-container');
            const max = MAX_SIMULTANEOUS_CALLS; // Now 24
            const current = callStats.currentCalls;
            const percentage = callStats.callLoadPercentage;

            let barColor = 'bg-blue-500';
            if (percentage > 80) {
                barColor = 'bg-red-600';
            } else if (percentage > 60) {
                barColor = 'bg-yellow-500';
            }
            
            const averageIntervalText = "20 seconds"; // Hardcoded for 3x speed
            const callTimeText = `${AVG_CALL_DURATION_MINS} minutes`;
            // 1x load = 3 calls/min * 60 min = 180 calls/hour
            const potentialCallsPerHour = Math.round(60 * AVG_CALLS_PER_MINUTE); 
            const systemCapacity = stats.totalUnits; // Now uses correctly parsed total


            container.innerHTML = `
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="kpi-card p-4 rounded-xl border-t-4 border-t-blue-500">
                        <p class="text-sm font-medium text-gray-400">Load Percentage</p>
                        <p class="text-2xl sm:text-3xl font-extrabold text-white mt-1">${percentage}%</p>
                    </div>
                    <div class="kpi-card p-4 rounded-xl border-t-4 border-t-blue-500">
                        <p class="text-sm font-medium text-gray-400">Total System Units</p>
                        <p class="text-2xl sm:text-3xl font-extrabold text-white mt-1">${systemCapacity.toLocaleString()}</p>
                    </div>
                    <div class="kpi-card p-4 rounded-xl border-t-4 border-t-blue-500">
                        <p class="text-sm font-medium text-gray-400">Avg. Call Duration</p>
                        <p class="text-2xl sm:text-3xl font-extrabold text-white mt-1">${callTimeText}</p>
                    </div>
                    <div class="kpi-card p-4 rounded-xl border-t-4 border-t-blue-500">
                        <p class="text-sm font-medium text-gray-400">Potential Calls/Hour (1x)</p>
                        <p class="text-2xl sm:text-3xl font-extrabold text-white mt-1">${potentialCallsPerHour}</p>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-semibold text-gray-300">Concurrent Calls In Progress</span>
                        <span class="text-lg font-bold ${barColor === 'bg-red-600' ? 'text-red-400' : 'text-blue-400'}">${current} / ${max}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div class="h-4 rounded-full ${barColor} transition-all duration-500 ease-out" style="width: ${percentage}%"></div>
                    </div>
                </div>
                
                <div class="p-4 bg-[#1c233a] rounded-lg border border-gray-700/50">
                    <h4 class="text-lg font-bold text-blue-400 mb-2">Dispatch Model Configuration</h4>
                    <ul class="text-sm space-y-1 text-gray-400 list-disc list-inside">
                        <li>**Average Call Start Interval:** One call every **${averageIntervalText}** (at 1x load).</li>
                        <li>**Calls Today:** The system has processed **${callsToday.toLocaleString()}** calls since midnight GMT.</li>
                        <li>**Model Note:** Current calls are dynamically adjusted based on time-of-day multipliers and system capacity.</li>
                    </ul>
                </div>
            `;
        }
        
        // --- LOCAL ASSET VIEW LOGIC (Unchanged) ---

        function handleRegionChange(regionKey) {
            activeRegionKey = regionKey;
            
            calculateStats(); 
            renderKPIs(); 
            renderCharts(); 
            renderLocalAssetView(regionKey);
        }

        function renderLocalAssetView(regionKey) {
            const container = document.getElementById('content-container');
            const titleElement = document.getElementById('local-viewer-title');
            const regionStatus = areaStatus[regionKey] || areaStatus.default;
            
            titleElement.textContent = `Local Operations: ${regionStatus.name}`;
            titleElement.className = `text-lg sm:text-xl font-bold mb-4 ${regionStatus.color}`;

            let htmlContent = '';
            
            function generateAssetTable(data) {
                if (!data || data.length === 0) {
                    return `<p class="text-center text-gray-500 py-4">No active units listed for this dispatch area.</p>`;
                }

                let tableHtml = `
                    <div class="table-responsive-wrapper max-h-[400px] overflow-y-auto scrollable-content mb-6">
                        <table class="data-table min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Station / Unit</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Code</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Location ID</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Assets (Quantity | Vehicle Code)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                `;

                data.forEach((unit, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-[#1c233a]/50' : 'bg-[#161c2e]/50';
                    tableHtml += `
                        <tr class="${rowClass} hover:bg-gray-700 transition duration-150">
                            <td class="px-3 py-2 text-xs sm:text-sm font-medium text-white">${unit.station}</td>
                            <td class="px-3 py-2 text-xs sm:text-sm text-blue-300">${unit.code}</td>
                            <td class="px-3 py-2 text-xs sm:text-sm text-gray-500">${unit.location}</td>
                            <td class="px-3 py-2 text-xs sm:text-sm text-gray-300">${unit.assets}</td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                return tableHtml;
            }
            
            if (regionKey === 'default') {
                htmlContent = `<p class="text-center text-gray-500 py-10">Use the selector above to filter local assets.</p>`;
            } else {
                const dispatchKey = regionMap[regionKey];
                const data = dispatchData[dispatchKey];
                htmlContent = generateAssetTable(data);
            }
            
            container.innerHTML = htmlContent;
        }
        
        // --- INITIALIZATION (Unchanged) ---
        function initDashboard() {
            if (!document.getElementById('kpi-summary')) {
                console.error("Dashboard failed to initialize: Missing 'kpi-summary' element.");
                return;
            }
            
            calculateStats();
            simulateCallStats(); 
            
            renderKPIs();
            renderCharts();
            renderNewsFeed();
            renderCallStatsCard(); 
            
            renderLocalAssetView('default');

            setInterval(function() {
                renderKPIs(); 
                renderCallStatsCard();
            }, 1000); 
        }

        window.onload = initDashboard;
    </script>
    <script>
    // Register the Service Worker (PWA functionality) - (Unchanged)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('Service Worker registered successfully with scope: ', registration.scope);
                
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('New content available, waiting for current clients to close or manually refresh.');
                        }
                    });
                });

            }).catch(error => {
                console.log('Service Worker registration failed: ', error);
            });
        });
    }
</script>

</body>
</html>
